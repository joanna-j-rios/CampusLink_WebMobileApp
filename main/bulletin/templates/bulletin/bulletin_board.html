{% extends 'base.html' %}
{% load static %}
{% block title %}Bulletin Board{% endblock %}

{% block content %}
{# Main page heading for the Bulletin Board. #}
<div class="bg-light text-dark p-3 mb-5 rounded-3 shadow-lg">
    <h1 class="display-4 text-center mb-0">Community Bulletin Board</h1>
</div>

{# Django messages framework for user feedback #}
{% if messages %}
    <div class="my-3">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    </div>
{% endif %}

{# Section for adding a new post (only visible to logged-in users) #}
{% if user.is_authenticated %}
    {# Button to open the Add New Post Modal #}
    <div class="text-center mb-5">
        <button type="button" class="btn btn-primary btn-lg shadow-sm" data-bs-toggle="modal" data-bs-target="#addPostModal">
            Add a New Post
        </button>
    </div>

    {# Bootstrap Modal for the Add New Post Form #}
    <div class="modal fade" id="addPostModal" tabindex="-1" aria-labelledby="addPostModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-bottom border-secondary">
                    <h5 class="modal-title" id="addPostModalLabel">Create New Post</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                {# Form for submitting a new post #}
                <form method="post" action="{% url 'bulletin_board' %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        {# Form fields rendered by Django, styled via bulletin/forms.py widgets #}
                        <div class="mb-3">
                            <label for="{{ form.title.id_for_label }}" class="form-label">Title</label>
                            {{ form.title }}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.content.id_for_label }}" class="form-label">Content</label>
                            {{ form.content }}
                        </div>
                        <div class="form-check mb-3">
                            {{ form.is_event }}
                            <label class="form-check-label" for="{{ form.is_event.id_for_label }}">Is this an event?</label>
                        </div>
                    </div>
                    <div class="modal-footer border-top border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-dark text-white">Publish Post</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endif %}

{# Display the empty posts message as a prominent black bar with white text if no posts exist #}
{% if not posts %}
    <div class="card p-4 text-center bg-dark text-white mb-5 shadow-lg">
        <p class="mb-0">No posts on the bulletin board yet. Be the first to post! </p>
    </div>
{% endif %}

{# List of Posts - only displayed if posts exist #}
{% if posts %}
    <h2 class="h3 mb-4 text-center text-secondary">All Community Posts</h2>
    <div class="row row-cols-1 g-4">
        {% for post in posts %}
        <div class="col">
            <div class="card my-3 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2"> {# Adjusted for alignment with delete button #}
                        <h5 class="card-title text-white flex-grow-1 me-2">{{ post.title }}</h5>
                        <div class="d-flex align-items-center"> {# Container for badge and delete button #}
                            {% if post.is_event %}
                            <span class="btn btn-dark text-white btn-sm me-2">Event</span> {# Event status button #}
                            {% endif %}
                            {# Delete button - only visible if current user is the author #}
                            {% if user.is_authenticated and user == post.author %}
                                <form method="post" action="{% url 'delete_post' post.pk %}" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-dark text-white btn-sm" onclick="return confirm('Are you sure you want to delete this post?');">Delete</button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                    <p class="card-text text-light-emphasis">{{ post.content }}</p>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        {# Removed redundant timestamp, now only showing author and date/time #}
                        <small class="text-info">Posted by {{ post.author.username }} on {{ post.timestamp|date:"F d, Y, P" }}</small> {# Removed H:i for less detail #}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% endif %}
    {% endblock %}
